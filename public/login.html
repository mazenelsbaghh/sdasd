<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول - مدير تعليقات Facebook</title>

    <!-- Facebook Login Button SDK -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/ar_AR/sdk.js"></script>

    <link rel="stylesheet" href="styles.css">
    <style>
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: #1877f2;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
        }

        .login-title {
            font-size: 24px;
            color: #1c1e21;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #65676b;
            margin-bottom: 30px;
        }

        .facebook-login-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .facebook-login-btn:hover {
            background: #166fe5;
        }

        .permissions-info {
            background: #f0f2f5;
            padding: 20px;
            border-radius: 8px;
            text-align: right;
            margin-top: 20px;
        }

        .permissions-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #1c1e21;
        }

        .permission-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: #65676b;
        }

        .permission-icon {
            color: #42a5f5;
            margin-left: 10px;
            font-size: 18px;
        }

        .status-message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }

        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        /* Facebook Login Button */
        .fb-login-button {
            margin: 20px 0;
            text-align: center;
        }

        .fb-login-button>span {
            width: 100% !important;
        }

        /* Custom Login Button */
        .facebook-login-btn {
            background: #1877f2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: background 0.3s;
        }

        .facebook-login-btn:hover {
            background: #166fe5;
        }

        /* Info Message */
        .info-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: right;
        }

        .info-message p {
            margin: 5px 0;
            color: #856404;
        }

        .info-message ul {
            margin: 10px 0;
            padding-right: 20px;
        }

        .info-message li {
            margin: 5px 0;
            color: #856404;
        }

        .info-message code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #d32f2f;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="login-logo">f</div>
        <h1 class="login-title">مرحباً بك في</h1>
        <p class="login-subtitle">مدير تعليقات Facebook</p>

        <!-- رسالة توضيحية -->
        <div class="info-message">
            <p>⚠️ <strong>ملاحظة مهمة:</strong></p>
            <p>Facebook يتطلب HTTPS للعمل. في التطوير المحلي، استخدم:</p>
            <ul>
                <li><strong>https://localhost:3000</strong> (مع شهادة SSL)</li>
                <li>أو أضف <strong>localhost</strong> في إعدادات Facebook App</li>
            </ul>
            <p style="margin-top: 15px; color: #d32f2f; font-weight: bold;">
                🔧 <strong>مشكلة JavaScript SDK:</strong><br>
                تأكد من تفعيل "تسجيل الدخول باستخدام JavaScript SDK" في Facebook App
            </p>
            <p style="font-size: 14px; margin-top: 10px;">
                راجع ملف <code>FACEBOOK_APP_SETUP.md</code> للتعليمات المفصلة
            </p>
        </div>

        <!-- زر تسجيل الدخول البسيط -->
        <button id="simpleLoginBtn" class="facebook-login-btn">
            تسجيل الدخول مع Facebook
        </button>

        <!-- زر إعادة المحاولة -->
        <button id="retryLoginBtn" class="facebook-login-btn"
            style="margin-top: 10px; background: #17a2b8; display: none;">
            إعادة المحاولة
        </button>

        <!-- زر فحص الحالة -->
        <button id="checkStatusBtn" class="facebook-login-btn" style="margin-top: 10px; background: #666;">
            فحص حالة تسجيل الدخول
        </button>

        <!-- زر فحص الاتصال -->
        <button id="checkConnectionBtn" class="facebook-login-btn" style="margin-top: 10px; background: #28a745;">
            فحص الاتصال بـ Facebook
        </button>

        <!-- زر إعادة تهيئة SDK -->
        <button id="reinitSDKBtn" class="facebook-login-btn"
            style="margin-top: 10px; background: #ffc107; color: #000;">
            إعادة تهيئة Facebook SDK
        </button>

        <!-- زر الذهاب إلى Facebook -->
        <button id="goToFacebookBtn" class="facebook-login-btn"
            style="margin-top: 10px; background: #1877f2; color: #fff;">
            الذهاب إلى Facebook لتسجيل الدخول
        </button>

        <div id="statusMessage" style="display: none;"></div>

        <!-- رسالة توضيحية -->
        <div class="info-message">
            <h3>تعليمات تسجيل الدخول:</h3>
            <ol>
                <li><strong>تأكد من تسجيل الدخول بـ Facebook أولاً</strong> - اذهب إلى <a
                        href="https://www.facebook.com" target="_blank">facebook.com</a></li>
                <li><strong>اضغط "تسجيل الدخول مع Facebook"</strong> - سيظهر نافذة Facebook</li>
                <li><strong>أعط الأذن للتطبيق</strong> - اضغط "Continue" أو "متابعة"</li>
                <li><strong>انتظر 30 ثانية</strong> - للاتصال بـ Facebook</li>
                <li><strong>اضغط "فحص الاتصال"</strong> - للتأكد من الاتصال</li>
            </ol>
            <p><strong>ملاحظة مهمة:</strong> يجب أن تكون مسجل دخول بـ Facebook في هذا المتصفح أولاً!</p>
            <p><strong>إذا لم يعمل:</strong> جرب إعادة تحميل الصفحة أو استخدام زر "إعادة تهيئة Facebook SDK"</p>
        </div>

        <div class="permissions-info">
            <div class="permissions-title">الصلاحيات المطلوبة:</div>
            <div class="permission-item">
                <span class="permission-icon">📖</span>
                قراءة التعليقات والمنشورات
            </div>
            <div class="permission-item">
                <span class="permission-icon">💬</span>
                الرد على التعليقات
            </div>
            <div class="permission-item">
                <span class="permission-icon">📊</span>
                إدارة الصفحة
            </div>
        </div>
    </div>

    <!-- Facebook SDK -->
    <script>
        function login() {
            console.log('Login button clicked');
            if (typeof FB === 'undefined') {
                showStatus('Facebook SDK لم يتم تحميله', 'error');
                return;
            }

            showStatus('تم فتح نافذة Facebook - اتبع التعليمات في النافذة', 'success');

            FB.login(function (res) {
                console.log('FB.login result:', res);
                console.log('Response details:', {
                    status: res.status,
                    authResponse: res.authResponse,
                    hasAccessToken: !!res.authResponse?.accessToken,
                    hasUserID: !!res.authResponse?.userID
                });

                if (res.authResponse && res.authResponse.accessToken) {
                    showStatus('تم تسجيل الدخول بنجاح!', 'success');
                    console.log('Login successful, proceeding to fetch user data...');
                    fetchMe();
                } else if (res.status === 'unknown') {
                    // User didn't complete the authorization
                    showStatus('لم تكمل عملية الأذن - تأكد من الضغط على "إعادة الاتصال" في نافذة Facebook', 'error');
                    console.log('User did not complete authorization - status: unknown');

                    // Show retry button
                    document.getElementById('retryLoginBtn').style.display = 'block';

                    // Give user specific instructions only after popup interaction
                    showStatus('تعليمات: 1) اضغط "إعادة الاتصال" في نافذة Facebook 2) انتظر حتى تغلق النافذة 3) اضغط "إعادة المحاولة"', 'success');
                } else {
                    showStatus('لم يتم إكمال تسجيل الدخول - جرب مرة أخرى', 'error');
                    console.log('Login incomplete - status:', res.status);

                    // Show retry button
                    document.getElementById('retryLoginBtn').style.display = 'block';
                }
            }, {
                scope: 'pages_read_engagement,pages_manage_posts,pages_show_list,email',
                return_scopes: true,
                auth_type: 'rerequest' // Force re-request permissions
            });
        }

        // إضافة event listener للزر
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('simpleLoginBtn').addEventListener('click', function () {
                login();
            });

            document.getElementById('retryLoginBtn').addEventListener('click', function () {
                login();
            });

            document.getElementById('checkStatusBtn').addEventListener('click', function () {
                if (typeof FB !== 'undefined') {
                    FB.getLoginStatus(handleStatus);
                } else {
                    showStatus('Facebook SDK لم يتم تحميله', 'error');
                }
            });

            document.getElementById('checkConnectionBtn').addEventListener('click', function () {
                checkConnection();
            });

            document.getElementById('reinitSDKBtn').addEventListener('click', function () {
                reinitializeFacebookSDK();
            });

            document.getElementById('goToFacebookBtn').addEventListener('click', function () {
                window.open('https://www.facebook.com', '_blank');
                showStatus('تم فتح Facebook في نافذة جديدة - سجل دخول هناك أولاً', 'success');
            });
        });

        window.fbAsyncInit = function () {
            console.log('fbAsyncInit called');
            try {
                FB.init({
                    appId: '655413053660463',
                    cookie: true,          // ضروري لو هتعتمد على جلسة الفيسبوك
                    xfbml: false,
                    version: 'v19.0'       // استخدم آخر نسخة مدعومة عندك
                });
                console.log('FB.init completed successfully');
                FB.AppEvents.logPageView();
                console.log('Facebook SDK initialized');

                // Check current login status after initialization
                FB.getLoginStatus(handleStatus);
                FB.Event.subscribe('auth.statusChange', handleStatus);

            } catch (error) {
                console.error('Error in FB.init:', error);
            }
        };

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        function handleStatus(response) {
            console.log('auth status:', response);
            if (response.status === 'connected') {
                // عندك accessToken و userID
                showStatus('أنت متصل بـ Facebook بالفعل!', 'success');
                console.log('User is connected with access token');
                // يمكنك الآن استدعاء API
                fetchMe();
            } else if (response.status === 'not_authorized') {
                // لازم تطلب صلاحيات للتطبيق
                showStatus('أنت متصل بـ Facebook لكن لم تمنح الأذن للتطبيق', 'error');
            } else {
                // 'unknown' => المستخدم مش logged in لفيسبوك أو الكوكيز محجوبة
                showStatus('أنت غير متصل بـ Facebook - سجل دخول أولاً', 'error');
            }
        }

        function fetchMe() {
            FB.api('/me', { fields: 'id,name,email' }, function (r) {
                console.log('ME:', r);
                if (r && !r.error) {
                    console.log('Successfully fetched user data:', r);
                    showStatus(`مرحباً ${r.name}! تم الاتصال بنجاح`, 'success');
                    // يمكنك الآن المتابعة
                    getPages();
                } else {
                    console.error('API error:', r.error);
                    const { message, code, subcode, type, fbtrace_id } = r.error;
                    console.error({ message, code, subcode, type, fbtrace_id });
                    showStatus(`خطأ في API: ${message} (Code: ${code})`, 'error');
                }
            });
        }

        function getPages() {
            FB.api('/me/accounts', function (response) {
                console.log('Pages response:', response);
                if (response && !response.error && response.data && response.data.length > 0) {
                    showStatus(`تم العثور على ${response.data.length} صفحة - جاري الانتقال...`, 'success');
                    // Store data and redirect
                    localStorage.setItem('fbPages', JSON.stringify(response.data));
                    setTimeout(() => {
                        window.location.href = 'https://localhost:3000/';
                    }, 2000);
                } else {
                    console.error('No pages found:', response);
                    if (response.error) {
                        const { message, code, subcode, type, fbtrace_id } = response.error;
                        console.error({ message, code, subcode, type, fbtrace_id });
                        showStatus(`خطأ في جلب الصفحات: ${message} (Code: ${code})`, 'error');
                    } else {
                        showStatus('لم يتم العثور على صفحات', 'error');
                    }
                }
            });
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
        }

        function checkLoginStatus() {
            if (typeof FB === 'undefined') {
                showStatus('Facebook SDK لم يتم تحميله', 'error');
                return;
            }

            FB.getLoginStatus(function (response) {
                console.log('Current login status:', response);
                console.log('Status:', response.status);
                console.log('Auth response:', response.authResponse);

                if (response.status === 'connected') {
                    showStatus('أنت مسجل دخول بالفعل!', 'success');
                    if (response.authResponse.accessToken) {
                        getPages(response.authResponse.accessToken);
                    }
                } else if (response.status === 'not_authorized') {
                    showStatus('أنت مسجل دخول لكن لم تمنح الأذن للتطبيق', 'error');
                } else {
                    showStatus('أنت غير مسجل دخول', 'error');
                }
            });
        }

        function checkConnection() {
            if (typeof FB === 'undefined') {
                showStatus('Facebook SDK لم يتم تحميله', 'error');
                return;
            }

            // Method 1: Check Facebook SDK status
            FB.getLoginStatus(function (response) {
                console.log('Checking connection status:', response);
                console.log('Status:', response.status);
                console.log('Auth response:', response.authResponse);

                if (response.status === 'connected') {
                    showStatus('أنت متصل بـ Facebook بالفعل!', 'success');
                } else if (response.status === 'not_authorized') {
                    showStatus('أنت متصل بـ Facebook لكن لم تمنح الأذن للتطبيق', 'error');
                } else {
                    // Method 2: Check Facebook cookies manually
                    checkFacebookCookies();
                }
            });
        }

        function checkFacebookCookies() {
            // Check if user has Facebook cookies (indicating they're logged in)
            const cookies = document.cookie.split(';');
            const fbCookies = cookies.filter(cookie =>
                cookie.trim().startsWith('c_user=') ||
                cookie.trim().startsWith('xs=') ||
                cookie.trim().startsWith('datr=')
            );

            console.log('Facebook cookies found:', fbCookies);

            if (fbCookies.length > 0) {
                showStatus('تم العثور على cookies Facebook - جاري محاولة الاتصال...', 'success');

                // Try to force a login status refresh
                FB.getLoginStatus(function (response) {
                    console.log('Forced login status check:', response);
                    if (response.status === 'connected' || response.authResponse) {
                        showStatus('تم الاتصال بنجاح!', 'success');
                        statusChangeCallback(response);
                    } else {
                        showStatus('أنت مسجل دخول بـ Facebook لكن لم تمنح الأذن للتطبيق', 'error');
                    }
                }, true); // Force refresh
            } else {
                showStatus('لم يتم العثور على cookies Facebook - أنت غير مسجل دخول', 'error');
            }
        }

        function reinitializeFacebookSDK() {
            console.log('Reinitializing Facebook SDK...');
            // Clear existing SDK script
            const facebookScript = document.getElementById('facebook-jssdk');
            if (facebookScript) {
                facebookScript.remove();
            }

            // Re-add the script tag
            const newScript = document.createElement('script');
            newScript.id = 'facebook-jssdk';
            newScript.src = 'https://connect.facebook.net/ar_AR/sdk.js'; // Use ar_AR for Arabic
            newScript.async = true;
            newScript.defer = true;
            newScript.crossOrigin = 'anonymous';
            newScript.onload = function () {
                console.log('Facebook SDK re-initialized successfully.');
                showStatus('Facebook SDK تم إعادة تهيئته بنجاح!', 'success');
                // After re-initialization, you might want to re-check login status or perform other actions
                // For now, just show a success message.
            };
            newScript.onerror = function () {
                console.error('Failed to re-initialize Facebook SDK.');
                showStatus('فشل إعادة تهيئة Facebook SDK: جرب تحميل الصفحة مرة أخرى', 'error');
            };

            document.head.appendChild(newScript);
        }
    </script>
</body>

</html>